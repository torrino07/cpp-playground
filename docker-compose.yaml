
# docker-compose.yml
services:
  dev:
    build:
      context: .
      dockerfile: Dockerfile
      # Choose base image via build args (optional)
      args:
        BASE: "${BASE_IMAGE:-ubuntu:24.04}"
    image: cpp-dev:${TARGET_ARCH:-arm64}
    # Set architecture explicitly (Mac M1 can do both; amd64 uses QEMU and is slower)
    platform: "linux/${TARGET_ARCH:-arm64}"
    working_dir: /workspace
    volumes:
      - .:/workspace:delegated
    stdin_open: true
    tty: true
    # Environment passed to container (can be used by cmake)
    environment:
      - CMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE:-Debug}
    # Default command puts you in a shell for interactive dev
    command: [ "bash", "-lc", "bash" ]
    profiles: ["dev"]

  # Automated build & test runner as a separate service
  ci:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BASE: "${BASE_IMAGE:-ubuntu:24.04}"
    image: cpp-ci:${TARGET_ARCH:-amd64}
    platform: "linux/${TARGET_ARCH:-amd64}"
    working_dir: /workspace
    volumes:
      - .:/workspace:delegated
    # Run configure, build, tests. Adjust to your project.
    command: >
      bash -lc "
      cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE:-Debug} &&
      cmake --build build -j &&
      ctest --test-dir build --output-on-failure &&
      ./build/app
      "
    profiles: ["ci"]
