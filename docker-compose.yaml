
services:
  dev:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BASE: "${BASE_IMAGE:-ubuntu:24.04}"
    image: cpp-dev:${TARGET_ARCH:-arm64}
    platform: "linux/${TARGET_ARCH:-arm64}"
    working_dir: /workspace
    volumes:
      - .:/workspace:delegated
    stdin_open: true
    tty: true
    command: ["bash", "-lc", "bash"]
    profiles: ["dev"]

    # CPU controls (non-Swarm)
    cpus: "${DEV_CPUS:-2.0}"        # limit to 2 cores worth of compute
    cpu_shares: 512                 # relative scheduling weight (default 1024)
    # Pin to specific logical cores (optional)
    # cpuset: "${DEV_CPUSET:-0-3}"

  ci:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BASE: "${BASE_IMAGE:-ubuntu:24.04}"
    image: cpp-ci:${TARGET_ARCH:-amd64}
    platform: "linux/${TARGET_ARCH:-amd64}"
    working_dir: /workspace
    volumes:
      - .:/workspace:delegated
    command: >
      bash -lc "
      cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE:-Debug} &&
      cmake --build build -j &&
      ctest --test-dir build --output-on-failure &&
      ./build/app
      "
    profiles: ["ci"]

    # CPU controls (non-Swarm)
    cpus: "${CI_CPUS:-3.0}"         # give CI a bit more
    cpu_shares: 1024
    # cpuset: "${CI_CPUSET:-0-5}"
